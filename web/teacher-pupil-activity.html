<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thinking like a Coder - Pupil Activity View</title>
  <link rel="stylesheet" href="./core/app.css" />
  <style>
    .answer-item {
      margin-bottom: 12px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.04);
    }
    .answer-item.correct { border-color: rgba(73,209,122,.6); background: rgba(73,209,122,.12); }
    .answer-item.incorrect { border-color: rgba(255,93,93,.6); background: rgba(255,93,93,.12); }
    .answer-key { font-weight: bold; margin-bottom: 4px; }
    .answer-value { margin-left: 10px; }
    .mark-btns { margin-top: 6px; }
    .mark-btns button { margin-right: 6px; }
    .answer-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-size: 0.9em;
    }
    .answer-status.correct { border-color: rgba(73,209,122,.6); color: var(--good); }
    .answer-status.incorrect { border-color: rgba(255,93,93,.6); color: var(--bad); }
    .answer-status.unmarked { color: var(--muted); }
    .answer-status-icon { font-weight: 700; }
    .answer-status.auto { margin-left: 8px; }
    .answer-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .answer-summary .summary-item {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-size: 0.9em;
    }
    .summary-item.good { color: var(--good); border-color: rgba(73,209,122,.5); }
    .summary-item.bad { color: var(--bad); border-color: rgba(255,93,93,.5); }
    .answer-section { margin-top: 14px; }
    .answer-section h3 { margin: 0 0 8px; font-size: 18px; }
    .checklist-view { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }
    .checklist-view li { display: flex; align-items: flex-start; gap: 8px; }
    .checklist-icon { font-weight: 700; width: 16px; display: inline-block; }
    .diff-list { margin: 8px 0 0; padding-left: 18px; }
    .revision-item { padding: 8px; border-bottom: 1px solid var(--border); }
    .revision-item:last-child { border-bottom: none; }
    .revision-meta { font-size: 0.85em; color: var(--muted); margin-bottom: 4px; }
    .feedback-item { padding: 10px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; background: rgba(255,255,255,.04); }
    .feedback-meta { font-size: 0.85em; color: var(--muted); margin-bottom: 4px; }
    .feedback-text { margin-top: 4px; }
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }
    .status-badge.complete { background: #2a2; color: white; }
    .status-badge.in_progress { background: #f90; color: white; }
    .status-badge.incomplete { background: #999; color: white; }
    .pupil-info { margin-bottom: 20px; }
    .score-display { font-size: 1.2em; font-weight: bold; margin: 10px 0; }
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-x: auto;
    }
  </style>
</head>
<body data-requires-role="teacher">
  <div class="topbar no-print">
    <div class="container">
      <div class="brand">
        <b>Thinking like a Coder - Pupil Activity View</b>
        <span>View and mark pupil work</span>
      </div>
      <div class="row">
        <a class="pill" href="./teacher.html"><strong>TEACHER</strong> <span>Teacher hub</span></a>
        <a class="pill" href="./teacher-view.html"><strong>VIEW</strong> <span>Teacher view</span></a>
        <a class="pill" href="./index.html"><strong>STUDENT</strong> <span>Student hub</span></a>
        <span id="userBadge" class="badge" style="display:none"></span>
        <button class="btn" id="logoutBtn" type="button">Logout</button>
        <button class="btn" id="teacherToggle" type="button">Teacher mode: OFF</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="loadingMsg" class="note">Loading activity data...</div>
    <div id="errorMsg" class="note warn" style="display:none"></div>

    <div id="mainContent" style="display:none">
      <div class="pupil-info">
        <h1 id="pageTitle">Pupil Activity</h1>
        <p><strong>Pupil:</strong> <span id="pupilName"></span> (<span id="pupilUsername"></span>)</p>
        <p><strong>Cohort:</strong> <span id="pupilCohort"></span></p>
      </div>

      <div class="grid cols2" style="margin-top:12px">
        <div class="card">
          <h2>Activity Status</h2>
          <p><strong>Activity:</strong> <span id="activityTitle"></span></p>
          <p><strong>Status:</strong> <span id="activityStatus" class="status-badge"></span></p>
          <p id="scoreDisplay" class="score-display" style="display:none">Score: <span id="scoreValue"></span></p>
          <p><strong>Attempt count:</strong> <span id="attemptCount">0</span></p>
          <p><strong>First save:</strong> <span id="firstSave">-</span></p>
          <p><strong>Last save:</strong> <span id="lastSave">-</span></p>
          <div id="activityContext" style="margin-top:12px"></div>
          <div style="margin-top:12px">
            <button class="btn" id="markCompleteBtn" type="button">Mark Complete</button>
            <button class="btn" id="markIncompleteBtn" type="button">Mark Incomplete</button>
          </div>
        </div>

        <div class="card">
          <h2>Add Feedback</h2>
          <label for="feedbackInput"><b>Teacher feedback for this activity</b></label>
          <textarea id="feedbackInput" placeholder="Enter feedback visible to the pupil..."></textarea>
          <div style="margin-top:10px">
            <button class="btn primary" id="saveFeedbackBtn" type="button">Save Feedback</button>
          </div>
          <div id="existingFeedback" style="margin-top:15px"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Pupil's Answers</h2>
        <div class="note">
          <b>Mark individual answers:</b> Click correct/incorrect to mark each answer. Green = correct, red = incorrect.
          Auto-check results (if available) appear under each answer.
        </div>
        <div id="answerSummary" class="answer-summary"></div>
        <div id="answersContainer" style="margin-top:12px">
          <p class="muted">No saved state yet.</p>
        </div>
        <div id="stateDiff" style="margin-top:12px"></div>
        <details style="margin-top:12px">
          <summary>View raw state JSON</summary>
          <pre id="rawState" class="json-view"></pre>
        </details>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Revision History</h2>
        <details>
          <summary>View <span id="revisionCount">0</span> revisions</summary>
          <div id="revisionsContainer" style="margin-top:10px">
            <p class="muted">No revisions.</p>
          </div>
        </details>
      </div>
    </div>

    <div class="footer">
      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script src="./core/error-handler.js"></script>
  <script src="./core/app.js"></script>
  <script src="./core/auth.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const username = params.get("username") || "";
    const lessonId = params.get("lesson_id") || "";
    const activityId = params.get("activity_id") || "";

    const loadingMsg = document.getElementById("loadingMsg");
    const errorMsg = document.getElementById("errorMsg");
    const mainContent = document.getElementById("mainContent");
    const pageTitle = document.getElementById("pageTitle");
    const pupilName = document.getElementById("pupilName");
    const pupilUsername = document.getElementById("pupilUsername");
    const pupilCohort = document.getElementById("pupilCohort");
    const activityTitle = document.getElementById("activityTitle");
    const activityStatus = document.getElementById("activityStatus");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const scoreValue = document.getElementById("scoreValue");
    const attemptCount = document.getElementById("attemptCount");
    const firstSave = document.getElementById("firstSave");
    const lastSave = document.getElementById("lastSave");
    const activityContext = document.getElementById("activityContext");
    const answerSummary = document.getElementById("answerSummary");
    const answersContainer = document.getElementById("answersContainer");
    const stateDiff = document.getElementById("stateDiff");
    const rawState = document.getElementById("rawState");
    const revisionsContainer = document.getElementById("revisionsContainer");
    const revisionCount = document.getElementById("revisionCount");
    const feedbackInput = document.getElementById("feedbackInput");
    const existingFeedback = document.getElementById("existingFeedback");
    const markCompleteBtn = document.getElementById("markCompleteBtn");
    const markIncompleteBtn = document.getElementById("markIncompleteBtn");
    const saveFeedbackBtn = document.getElementById("saveFeedbackBtn");

    let activityData = null;
    let currentMark = null;
    let manifestCache = null;

    function showError(msg) {
      loadingMsg.style.display = "none";
      errorMsg.textContent = msg;
      errorMsg.style.display = "";
    }

    function formatDateTime(iso) {
      if (!iso) return "-";
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    async function ensureManifest() {
      if (manifestCache) return manifestCache;
      try {
        const res = await fetch("/lessons/manifest.json", { credentials: "same-origin" });
        if (!res.ok) return null;
        manifestCache = await res.json().catch(() => null);
      } catch {
        manifestCache = null;
      }
      return manifestCache;
    }

    function buildActivityContext(meta, lessonId, activityId) {
      if (!meta && !manifestCache) return "";
      const lesson = (manifestCache?.lessons || []).find(item => item.id === lessonId);
      const activity = lesson?.activities?.find(item => item.id === activityId);
      const objectiveIds = meta?.objectives || activity?.objectiveIds || [];
      const objectiveTexts = [];
      if (lesson?.objectives && objectiveIds.length) {
        objectiveIds.forEach(id => {
          const obj = lesson.objectives.find(item => item.id === id);
          if (obj?.text) {
            objectiveTexts.push(`${id}: ${obj.text}`);
          } else {
            objectiveTexts.push(id);
          }
        });
      } else {
        objectiveIds.forEach(id => objectiveTexts.push(id));
      }
      const evidence = activity?.expectedEvidence || "";

      if (!objectiveTexts.length && !evidence) return "";
      return `
        <div class="note" style="margin:0">
          ${objectiveTexts.length ? `<div style="margin-bottom:6px"><b>Objectives:</b><br>${objectiveTexts.map(escapeHtml).join("<br>")}</div>` : ""}
          ${evidence ? `<div><b>Expected evidence:</b> ${escapeHtml(evidence)}</div>` : ""}
        </div>
      `;
    }

    function renderAnswerValue(value) {
      if (value === null || value === undefined || value === "") {
        return '<span class="muted">No answer</span>';
      }
      if (typeof value === "boolean") {
        return value ? "Yes" : "No";
      }
      const parsed = typeof tryParseJsonString === "function" ? tryParseJsonString(value) : null;
      if (parsed !== null) {
        if (typeof renderStateReadable === "function") {
          return renderStateReadable(parsed);
        }
        return `<pre style="margin:0;white-space:pre-wrap">${escapeHtml(JSON.stringify(parsed, null, 2))}</pre>`;
      }
      if (typeof value === "object") {
        if (typeof renderStateReadable === "function") {
          return renderStateReadable(value);
        }
        return `<pre style="margin:0;white-space:pre-wrap">${escapeHtml(JSON.stringify(value, null, 2))}</pre>`;
      }
      // Check if it looks like code
      const s = String(value);
      if (s.includes("\n") || s.includes("def ") || s.includes("print(") || s.includes("import ")) {
        return `<div class="code-block">${escapeHtml(s)}</div>`;
      }
      return escapeHtml(s);
    }

    function renderAnswerSummary(entries, marks, autoChecks) {
      if (!entries.length) {
        answerSummary.innerHTML = "";
        return;
      }
      let teacherCorrect = 0;
      let teacherIncorrect = 0;
      let autoCorrect = 0;
      let autoIncorrect = 0;
      entries.forEach(([key]) => {
        const markInfo = marks?.[key] || {};
        if (markInfo.correct === true) teacherCorrect += 1;
        if (markInfo.correct === false) teacherIncorrect += 1;
        const auto = autoChecks?.[key];
        if (auto === true) autoCorrect += 1;
        if (auto === false) autoIncorrect += 1;
      });
      const teacherUnmarked = Math.max(0, entries.length - teacherCorrect - teacherIncorrect);
      answerSummary.innerHTML = `
        <span class="summary-item">${entries.length} answers</span>
        <span class="summary-item good">Teacher correct: ${teacherCorrect}</span>
        <span class="summary-item bad">Teacher incorrect: ${teacherIncorrect}</span>
        <span class="summary-item">Unmarked: ${teacherUnmarked}</span>
        ${autoCorrect || autoIncorrect ? `
          <span class="summary-item good">Auto-check correct: ${autoCorrect}</span>
          <span class="summary-item bad">Auto-check incorrect: ${autoIncorrect}</span>
        ` : ""}
      `;
    }

    function renderAnswerItems(entries, marks, autoChecks) {
      if (!entries.length) {
        return '<p class="muted">No answers saved.</p>';
      }
      renderAnswerSummary(entries, marks, autoChecks);
      return entries.map(([key, value]) => {
        const markInfo = marks?.[key] || {};
        const teacherCorrect = markInfo.correct === true;
        const teacherIncorrect = markInfo.correct === false;
        const autoStatus = autoChecks?.[key];
        const cssClass = teacherCorrect ? "correct" : (teacherIncorrect ? "incorrect" : "");
        const attempts = markInfo.attempts || 0;
        const statusClass = teacherCorrect ? "correct" : (teacherIncorrect ? "incorrect" : "unmarked");
        const statusIcon = teacherCorrect ? "&#10003;" : (teacherIncorrect ? "&#10007;" : "&ndash;");
        const statusLabel = teacherCorrect ? "Teacher: correct" : (teacherIncorrect ? "Teacher: incorrect" : "Teacher: not marked");
        const autoClass = autoStatus === true ? "correct" : (autoStatus === false ? "incorrect" : "unmarked");
        const autoIcon = autoStatus === true ? "&#10003;" : (autoStatus === false ? "&#10007;" : "&ndash;");
        const autoLabel = autoStatus === true ? "Auto-check: correct" : (autoStatus === false ? "Auto-check: incorrect" : "Auto-check: not checked");

        return `
          <div class="answer-item ${cssClass}" data-question-id="${escapeHtml(key)}">
            <div class="answer-key">${escapeHtml(key)}</div>
            <div class="answer-value">${renderAnswerValue(value)}</div>
            <div class="answer-status ${statusClass}">
              <span class="answer-status-icon">${statusIcon}</span>
              <span>${statusLabel}</span>
            </div>
            ${autoStatus !== undefined ? `
              <div class="answer-status auto ${autoClass}">
                <span class="answer-status-icon">${autoIcon}</span>
                <span>${autoLabel}</span>
              </div>
            ` : ""}
            ${attempts > 0 ? `<div class="muted" style="margin-top:4px">Attempts: ${attempts}</div>` : ""}
            <div class="mark-btns">
              <button class="btn ${teacherCorrect ? 'good' : ''}" data-mark-correct="${escapeHtml(key)}" type="button">
                Correct
              </button>
              <button class="btn ${teacherIncorrect ? 'bad' : ''}" data-mark-incorrect="${escapeHtml(key)}" type="button">
                Incorrect
              </button>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderKeyValueSection(title, entries) {
      if (!entries.length) return "";
      const items = entries.map(([key, value]) => (
        `<div class="state-row"><dt>${escapeHtml(key)}</dt><dd>${renderAnswerValue(value)}</dd></div>`
      )).join("");
      return `
        <div class="answer-section">
          <h3>${escapeHtml(title)}</h3>
          <dl class="state-dl">${items}</dl>
        </div>
      `;
    }

    function renderChecklistSection(entries) {
      if (!entries.length) return "";
      const items = entries.map(([key, value]) => {
        const checked = !!value;
        const icon = checked ? "&#10003;" : "&#10007;";
        const className = checked ? "good" : "bad";
        return `<li><span class="checklist-icon ${className}">${icon}</span><span>${escapeHtml(key)}</span></li>`;
      }).join("");
      return `
        <div class="answer-section">
          <h3>Checklist</h3>
          <ul class="checklist-view">${items}</ul>
        </div>
      `;
    }

    function renderCodeSection(code) {
      if (!code) return "";
      return `
        <div class="answer-section">
          <h3>Code</h3>
          <div class="code-block">${escapeHtml(code)}</div>
        </div>
      `;
    }

    function renderOutputSection(output) {
      if (!output) return "";
      const meta = [];
      if (output.exit_code !== undefined && output.exit_code !== null) meta.push(`Exit: ${output.exit_code}`);
      if (output.timed_out) meta.push("Timed out");
      if (output.duration_ms) meta.push(`Duration: ${output.duration_ms}ms`);
      if (output.ran_at) meta.push(`Ran: ${formatDateTime(output.ran_at)}`);
      const stdout = output.stdout || "";
      const stderr = output.stderr || "";
      return `
        <div class="answer-section">
          <h3>Run Output</h3>
          ${meta.length ? `<div class="muted" style="margin-bottom:6px">${escapeHtml(meta.join(" Â· "))}</div>` : ""}
          ${stdout ? `<div><b>Stdout</b><div class="code-block">${escapeHtml(stdout)}</div></div>` : ""}
          ${stderr ? `<div style="margin-top:8px"><b>Stderr</b><div class="code-block">${escapeHtml(stderr)}</div></div>` : ""}
        </div>
      `;
    }

    function renderFilesSection(files) {
      if (!Array.isArray(files) || !files.length) return "";
      const items = files.map(file => {
        const path = file.path || "file";
        const mime = file.mime ? ` (${file.mime})` : "";
        return `<li>${escapeHtml(path)}${escapeHtml(mime)}</li>`;
      }).join("");
      return `
        <div class="answer-section">
          <h3>Saved files</h3>
          <ul class="state-list">${items}</ul>
        </div>
      `;
    }

    function renderAnswers(state, answerMarks) {
      const stateObj = state && typeof state === "object" && !Array.isArray(state) ? state : null;
      if (!stateObj) {
        answersContainer.innerHTML = '<p class="muted">No saved state yet.</p>';
        answerSummary.innerHTML = "";
        return;
      }

      answerSummary.innerHTML = "";
      const marks = answerMarks || {};
      const autoChecks = stateObj.checked || {};
      const knownKeys = new Set([
        "answers",
        "notes",
        "checklist",
        "checked",
        "code",
        "output",
        "files",
        "hintsUsed",
        "hints_used"
      ]);
      const answerEntries = stateObj.answers && typeof stateObj.answers === "object" && !Array.isArray(stateObj.answers)
        ? Object.entries(stateObj.answers)
        : Object.entries(stateObj).filter(([key]) => !knownKeys.has(key));
      const notesEntries = stateObj.notes && typeof stateObj.notes === "object" ? Object.entries(stateObj.notes) : [];
      const checklistEntries = stateObj.checklist && typeof stateObj.checklist === "object" ? Object.entries(stateObj.checklist) : [];
      const sections = [];

      sections.push(`
        <div class="answer-section">
          <h3>Answers</h3>
          ${renderAnswerItems(answerEntries, marks, autoChecks)}
        </div>
      `);

      if (notesEntries.length) {
        sections.push(renderKeyValueSection("Notes", notesEntries));
      }

      if (checklistEntries.length) {
        sections.push(renderChecklistSection(checklistEntries));
      }

      if (stateObj.code) {
        sections.push(renderCodeSection(stateObj.code));
      }

      if (stateObj.output) {
        sections.push(renderOutputSection(stateObj.output));
      }

      if (stateObj.files) {
        sections.push(renderFilesSection(stateObj.files));
      }

      const extraEntries = Object.entries(stateObj).filter(([key]) => {
        if (stateObj.answers && !Array.isArray(stateObj.answers)) return false;
        return !knownKeys.has(key);
      });
      if (!stateObj.answers && extraEntries.length && !answerEntries.length) {
        answerSummary.innerHTML = "";
        sections.push(renderKeyValueSection("Responses", extraEntries));
      }

      const hintSummary = typeof renderHintSummary === "function" ? renderHintSummary(stateObj) : "";
      answersContainer.innerHTML = `${hintSummary}${sections.join("")}`;
    }

    function renderRawState(state) {
      if (!rawState) return;
      if (!state) {
        rawState.textContent = "";
        return;
      }
      try {
        rawState.textContent = JSON.stringify(state, null, 2);
      } catch {
        rawState.textContent = String(state);
      }
    }

    function diffStates(prev, curr, path, depth, output) {
      if (depth > 4) {
        if (JSON.stringify(prev) !== JSON.stringify(curr)) {
          output.push(path || "(root)");
        }
        return;
      }
      if (prev === curr) return;
      if (prev === null || curr === null || typeof prev !== typeof curr) {
        output.push(path || "(root)");
        return;
      }
      if (typeof prev !== "object") {
        output.push(path || "(root)");
        return;
      }
      if (Array.isArray(prev) || Array.isArray(curr)) {
        if (!Array.isArray(prev) || !Array.isArray(curr) || prev.length !== curr.length) {
          output.push(path || "(root)");
          return;
        }
        prev.forEach((item, idx) => {
          diffStates(item, curr[idx], `${path || "items"}[${idx}]`, depth + 1, output);
        });
        return;
      }
      const keys = new Set([...Object.keys(prev || {}), ...Object.keys(curr || {})]);
      keys.forEach((key) => {
        diffStates(prev[key], curr[key], path ? `${path}.${key}` : key, depth + 1, output);
      });
    }

    function renderStateDiff(revisions, latestState) {
      if (!stateDiff) return;
      if (!revisions || revisions.length < 2) {
        stateDiff.innerHTML = '<div class="note">No previous revision to compare.</div>';
        return;
      }
      const current = latestState || revisions[0]?.state;
      const previous = revisions[1]?.state;
      if (!current || !previous) {
        stateDiff.innerHTML = '<div class="note">No previous revision to compare.</div>';
        return;
      }
      const changes = [];
      diffStates(previous, current, "", 0, changes);
      const unique = Array.from(new Set(changes)).filter(Boolean);
      const preview = unique.slice(0, 12);
      const list = preview.map(item => `<li>${escapeHtml(item)}</li>`).join("");
      stateDiff.innerHTML = `
        <details>
          <summary>Latest changes vs previous save (${unique.length})</summary>
          ${unique.length ? `<ul class="diff-list">${list}</ul>` : '<div class="muted">No detected differences.</div>'}
          ${unique.length > preview.length ? `<div class="muted">Showing first ${preview.length} changes.</div>` : ""}
        </details>
      `;
    }

    function renderRevisions(revisions) {
      if (!revisions || !revisions.length) {
        revisionCount.textContent = "0";
        revisionsContainer.innerHTML = '<p class="muted">No revisions.</p>';
        return;
      }

      revisionCount.textContent = String(revisions.length);
      revisionsContainer.innerHTML = revisions.map((rev, idx) => `
        <div class="revision-item">
          <div class="revision-meta">
            <strong>#${revisions.length - idx}</strong> - ${formatDateTime(rev.created_at)}
            ${rev.client_saved_at ? `(client: ${formatDateTime(rev.client_saved_at)})` : ""}
          </div>
          <details>
            <summary>View state</summary>
            <div style="margin-top:8px">${renderStateReadable(rev.state)}</div>
          </details>
        </div>
      `).join("");
    }

    function renderFeedback(feedbackList) {
      if (!feedbackList || !feedbackList.length) {
        existingFeedback.innerHTML = '<p class="muted">No feedback yet.</p>';
        return;
      }

      existingFeedback.innerHTML = `<h4>Existing Feedback</h4>` + feedbackList.map(fb => `
        <div class="feedback-item" data-feedback-id="${fb.id}">
          <div class="feedback-meta">
            <strong>${escapeHtml(fb.teacher_name || "Teacher")}</strong> - ${formatDateTime(fb.created_at)}
          </div>
          <div class="feedback-text">${escapeHtml(fb.feedback_text)}</div>
          <button class="btn" data-delete-feedback="${fb.id}" type="button" style="margin-top:6px">Delete</button>
        </div>
      `).join("");
    }

    function updateStatusDisplay(mark) {
      const status = mark?.status || "incomplete";
      activityStatus.textContent = status;
      activityStatus.className = `status-badge ${status}`;

      attemptCount.textContent = String(mark?.attempt_count || 0);
      firstSave.textContent = formatDateTime(mark?.first_save_at);
      lastSave.textContent = formatDateTime(mark?.last_save_at);

      if (mark?.score !== null && mark?.score !== undefined && mark?.max_score) {
        scoreDisplay.style.display = "";
        scoreValue.textContent = `${mark.score} / ${mark.max_score}`;
      } else {
        scoreDisplay.style.display = "none";
      }
    }

    async function loadActivityData() {
      if (!username || !lessonId || !activityId) {
        showError("Missing required parameters. URL should include username, lesson_id, and activity_id.");
        return;
      }

      try {
        const res = await fetch(
          `/api/teacher/pupil/${encodeURIComponent(username)}/activity/${encodeURIComponent(lessonId)}/${encodeURIComponent(activityId)}`,
          { credentials: "same-origin" }
        );

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          showError(errData.detail || `Failed to load activity data (${res.status})`);
          return;
        }

        activityData = await res.json();
        currentMark = activityData.mark;
        await ensureManifest();
        renderActivityData();

        loadingMsg.style.display = "none";
        mainContent.style.display = "";
      } catch (err) {
        showError("Failed to load activity data: " + err.message);
      }
    }

    function renderActivityData() {
      const pupil = activityData.pupil || {};
      const state = activityData.state?.state || null;
      const mark = activityData.mark;
      const revisions = activityData.revisions || [];
      const feedback = activityData.feedback || [];
      const meta = activityData.activity_meta || {};

      // Set page info
      const title = meta.title || activityId;
      pageTitle.textContent = `${lessonId} / ${activityId}: ${title}`;
      document.title = `${activityId} - ${pupil.name || username}`;

      // Pupil info
      pupilName.textContent = pupil.name || "-";
      pupilUsername.textContent = pupil.username || username;
      pupilCohort.textContent = pupil.cohort_year || "-";

      // Activity info
      activityTitle.textContent = title;
      updateStatusDisplay(mark);
      activityContext.innerHTML = buildActivityContext(meta, lessonId, activityId);

      // Answers
      renderAnswers(state, mark?.answer_marks);
      renderStateDiff(revisions, state);
      renderRawState(state);

      // Revisions
      renderRevisions(revisions);

      // Feedback
      renderFeedback(feedback);
    }

    async function markAnswer(questionId, correct) {
      const auth = await window.tlacAuthReady;
      if (!auth) {
        toast("Not signed in.");
        return;
      }

      try {
        const res = await fetch("/api/teacher/answer-mark", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": auth.csrf_token
          },
          credentials: "same-origin",
          body: JSON.stringify({
            username,
            lesson_id: lessonId,
            activity_id: activityId,
            question_id: questionId,
            correct
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          toast(err.detail || "Failed to mark answer.");
          return;
        }

        const data = await res.json();
        currentMark = data.mark;

        // Re-render with new marks
        const state = activityData.state?.state || null;
        renderAnswers(state, currentMark?.answer_marks);
        updateStatusDisplay(currentMark);
        toast("Answer marked.");
      } catch (err) {
        toast("Error marking answer: " + err.message);
      }
    }

    async function setOverallMark(status) {
      const auth = await window.tlacAuthReady;
      if (!auth) {
        toast("Not signed in.");
        return;
      }

      try {
        const res = await fetch("/api/teacher/mark", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": auth.csrf_token
          },
          credentials: "same-origin",
          body: JSON.stringify({
            username,
            lesson_id: lessonId,
            activity_id: activityId,
            status
          })
        });

        if (!res.ok) {
          toast("Failed to update status.");
          return;
        }

        toast(`Marked as ${status}.`);
        await loadActivityData();
      } catch (err) {
        toast("Error: " + err.message);
      }
    }

    async function saveFeedback() {
      const auth = await window.tlacAuthReady;
      if (!auth) {
        toast("Not signed in.");
        return;
      }

      const text = feedbackInput.value.trim();
      if (!text) {
        toast("Enter feedback text.");
        return;
      }

      try {
        const res = await fetch("/api/teacher/feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": auth.csrf_token
          },
          credentials: "same-origin",
          body: JSON.stringify({
            username,
            lesson_id: lessonId,
            activity_id: activityId,
            feedback_text: text
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          toast(err.detail || "Failed to save feedback.");
          return;
        }

        feedbackInput.value = "";
        toast("Feedback saved.");
        await loadActivityData();
      } catch (err) {
        toast("Error: " + err.message);
      }
    }

    async function deleteFeedback(feedbackId) {
      const auth = await window.tlacAuthReady;
      if (!auth) {
        toast("Not signed in.");
        return;
      }

      if (!confirm("Delete this feedback?")) return;

      try {
        const res = await fetch(`/api/teacher/feedback/${encodeURIComponent(feedbackId)}`, {
          method: "DELETE",
          headers: {
            "X-CSRF-Token": auth.csrf_token
          },
          credentials: "same-origin"
        });

        if (!res.ok) {
          toast("Failed to delete feedback.");
          return;
        }

        toast("Feedback deleted.");
        await loadActivityData();
      } catch (err) {
        toast("Error: " + err.message);
      }
    }

    // Event delegation for answer marking
    answersContainer.addEventListener("click", (e) => {
      const correctBtn = e.target.closest("button[data-mark-correct]");
      if (correctBtn) {
        markAnswer(correctBtn.dataset.markCorrect, true);
        return;
      }
      const incorrectBtn = e.target.closest("button[data-mark-incorrect]");
      if (incorrectBtn) {
        markAnswer(incorrectBtn.dataset.markIncorrect, false);
        return;
      }
    });

    // Event delegation for feedback deletion
    existingFeedback.addEventListener("click", (e) => {
      const deleteBtn = e.target.closest("button[data-delete-feedback]");
      if (deleteBtn) {
        deleteFeedback(deleteBtn.dataset.deleteFeedback);
      }
    });

    markCompleteBtn.addEventListener("click", () => setOverallMark("complete"));
    markIncompleteBtn.addEventListener("click", () => setOverallMark("incomplete"));
    saveFeedbackBtn.addEventListener("click", saveFeedback);

    // Initialize
    loadActivityData();
  </script>
</body>
</html>
