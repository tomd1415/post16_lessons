{
  admin off
}

http://:80 {
  redir https://{host}{uri}
}

http://:8080 {
  redir https://{host}:8443{uri}
}

https://:443 {
  tls /etc/caddy/certs/server.crt /etc/caddy/certs/server.key

  header {
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }

  reverse_proxy api:8000 {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
  }
}

https://:8443 {
  tls /etc/caddy/certs/server.crt /etc/caddy/certs/server.key

  # Security headers
  header {
    # Content Security Policy - prevents XSS and injection attacks
    # Note: 'unsafe-inline' for script-src and style-src is needed for inline scripts and styles
    # TODO: Consider moving to nonces or hashes for production for better security
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"

    # Prevent clickjacking attacks
    X-Frame-Options "DENY"

    # Prevent MIME type sniffing
    X-Content-Type-Options "nosniff"

    # Enable browser XSS protection (legacy but still useful)
    X-XSS-Protection "1; mode=block"

    # Control referrer information
    Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions policy (formerly Feature-Policy)
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }

  # Reverse proxy with header forwarding
  reverse_proxy api:8000 {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
  }
}
